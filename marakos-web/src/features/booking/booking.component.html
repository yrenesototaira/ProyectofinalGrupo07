<div class="max-w-4xl mx-auto bg-slate-800 rounded-lg shadow-2xl shadow-black/30 overflow-hidden">
  <!-- Progress Bar -->
  <div class="p-6 border-b border-slate-700">
    <div class="flex items-center justify-between">
      @for(stepInfo of ['Datos', 'Disponibilidad', 'Mesa', 'Men√∫', 'Resumen', 'Pago', 'Tarjeta']; track $index; let i = $index) {
        <div class="flex items-center" [class.opacity-50]="step() < i + 1">
          <div class="flex items-center justify-center w-10 h-10 rounded-full" [class]="step() >= i + 1 ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-400'">
            <span class="font-bold">{{ i + 1 }}</span>
          </div>
          <span class="ml-3 font-medium" [class]="step() >= i + 1 ? 'text-amber-500' : 'text-slate-400'">
            {{ stepInfo }}
          </span>
        </div>
        @if (i < 6) {
          <div class="flex-auto border-t-2 mx-4" [class]="step() > i + 1 ? 'border-amber-500' : 'border-slate-700'"></div>
        }
      }
    </div>
  </div>

  <div class="p-8">
    @switch (step()) {
      <!-- Step 1: Customer Details -->
      @case (1) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üçΩÔ∏è Reserva tu Mesa</h2>
          <p class="text-slate-300 text-center mb-8">Disfruta de un momento especial!</p>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Current User Info -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">üë• Usuario</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- TODO: Replace with actual user service data when backend is ready -->
                <div class="space-y-4">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Nombre:</span>
                    <span class="font-semibold">{{ currentUser()?.nombre + ' ' + currentUser()?.apellido || 'Usuario Mockeado' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Email:</span>
                    <span class="font-semibold">{{ currentUser()?.email || 'usuario@marakos.com' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Tipo:</span>
                    <span class="font-semibold">{{ currentUser()?.tipoUsuario || 'Cliente' }}</span>
                  </div>
                </div>
                <div class="mt-4 p-3 bg-blue-900 rounded-lg">
                  <p class="text-blue-200 text-sm">
                    üí° Puedes hacer la reserva para otra persona modificando los datos del titular
                  </p>
                </div>
              </div>
            </div>

            <!-- Reservation Holder Details -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">‚úèÔ∏è Datos del Titular</h3>
              <div class="space-y-4">
                <div>
                  <label for="customerDocument" class="block text-sm font-medium text-slate-300 mb-2">Documento de Identidad *</label>
                  <input 
                    type="text" 
                    id="customerDocument" 
                    [ngModel]="customerDocument()" 
                    (ngModelChange)="updateCustomerField('document', $event)"
                    placeholder="Ingresa el documento de identidad"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>

                <div>
                  <label for="customerName" class="block text-sm font-medium text-slate-300 mb-2">Nombre Completo *</label>
                  <input 
                    type="text" 
                    id="customerName" 
                    [ngModel]="customerName()" 
                    (ngModelChange)="updateCustomerField('name', $event)"
                    placeholder="Ingresa el nombre completo"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerEmail" class="block text-sm font-medium text-slate-300 mb-2">Email *</label>
                  <input 
                    type="email" 
                    id="customerEmail" 
                    [ngModel]="customerEmail()" 
                    (ngModelChange)="updateCustomerField('email', $event)"
                    placeholder="ejemplo@correo.com"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerPhone" class="block text-sm font-medium text-slate-300 mb-2">Tel√©fono *</label>
                  <input 
                    type="tel" 
                    id="customerPhone" 
                    [ngModel]="customerPhone()" 
                    (ngModelChange)="updateCustomerField('phone', $event)"
                    placeholder="+51 999 888 777"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 text-center">
            <button 
              (click)="nextStep()" 
              [disabled]="!canProceedFromStep1()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 2: Date, Time, Guests -->
      @case (2) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üìÖ Elige la fecha y hora</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Calendar -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">Selecciona la Fecha</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-4">
                  <button (click)="previousMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Äπ</span>
                  </button>
                  <h4 class="text-lg font-semibold">{{ getMonthName() }} {{ currentCalendarYear() }}</h4>
                  <button (click)="nextMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Ä∫</span>
                  </button>
                </div>

                <!-- Days of week -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  @for(day of ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b']; track day) {
                    <div class="text-center text-sm font-medium text-slate-400 p-2">{{ day }}</div>
                  }
                </div>

                <!-- Calendar Days -->
                <div class="grid grid-cols-7 gap-1">
                  @for(day of getCalendarDays(); track $index; let i = $index) {
                    <button 
                      (click)="selectCalendarDate(day)"
                      [disabled]="!isDateAvailable(day)"
                      class="p-3 text-sm rounded-lg transition-all duration-200"
                      [class.bg-amber-500]="isDateSelected(day)"
                      [class.text-slate-900]="isDateSelected(day)"
                      [class.font-bold]="isDateSelected(day)"
                      [class.bg-emerald-600]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.hover:bg-emerald-500]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.text-white]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.bg-slate-600]="!isDateAvailable(day)"
                      [class.text-slate-500]="!isDateAvailable(day)"
                      [class.cursor-not-allowed]="!isDateAvailable(day)">
                      {{ day || '' }}
                    </button>
                  }
                </div>
              </div>
            </div>

            <!-- Time and Guests Selection -->
            <div class="space-y-6">
              <!-- Guest Count -->
              <div>
                <label for="guests" class="block text-xl font-semibold text-amber-500 mb-4">üë• N√∫mero de Comensales</label>
                <select id="guests" [ngModel]="guests()" (ngModelChange)="guests.set($event)" class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                  @for(i of [1,2,3,4,5,6,7,8]; track i) { <option [value]="i">{{ i }} Comensal{{ i > 1 ? 'es' : '' }}</option> }
                </select>
              </div>

              <!-- Time Selection -->
              <div>
                <label for="time" class="block text-xl font-semibold text-amber-500 mb-4">üïê Hora de la Reserva</label>
                <div class="grid grid-cols-2 gap-3">
                  @for(timeSlot of availableTimes(); track timeSlot.time) {
                    <button 
                      (click)="selectedTime.set(timeSlot.time)"
                      [disabled]="!timeSlot.available"
                      class="p-3 rounded-lg border-2 transition-all duration-300 text-sm"
                      [class.bg-amber-500]="selectedTime() === timeSlot.time"
                      [class.border-amber-500]="selectedTime() === timeSlot.time"
                      [class.text-slate-900]="selectedTime() === timeSlot.time"
                      [class.bg-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.border-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.text-white]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.hover:bg-emerald-500]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.bg-slate-600]="!timeSlot.available"
                      [class.border-slate-600]="!timeSlot.available"
                      [class.text-slate-500]="!timeSlot.available"
                      [class.cursor-not-allowed]="!timeSlot.available">
                      {{ timeSlot.label }}
                      @if (!timeSlot.available) {
                        <div class="text-xs opacity-75">No disponible</div>
                      }
                    </button>
                  }
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 flex justify-center gap-4">
            <button 
              (click)="prevStep()" 
              class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">
              ü†¨ Atr√°s
            </button>
            <button 
              (click)="checkAvailability()" 
              [disabled]="!canProceedFromStep2()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 3: Select Table -->
      @case (3) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">3. Selecciona tu Mesa</h2>
          
          <!-- Table Selection by Location -->
          <div class="space-y-6">
            @for(location of getLocationGroups(); track location.name) {
              <div class="p-6 bg-slate-900 rounded-lg border border-slate-700">
                <div class="flex items-center mb-4">
                  <span class="text-2xl mr-3">{{ getLocationIcon(location.name) }}</span>
                  <h3 class="text-xl font-semibold text-slate-100">{{ location.name }}</h3>
                  <span class="ml-2 text-sm text-slate-400">({{ location.tables.length }} mesas)</span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                  @for(table of location.tables; track table.id) {
                    <div 
                      class="relative group cursor-pointer transition-all duration-300 transform hover:scale-105"
                      [class.opacity-50]="!table.isAvailable || table.capacity < guests()"
                      [class.cursor-not-allowed]="!table.isAvailable || table.capacity < guests()"
                      (click)="selectTable(table)">
                      
                      <!-- Table Visual -->
                      <div 
                        class="flex flex-col items-center justify-center h-20 w-20 mx-auto text-slate-100 font-bold transition-all duration-300 relative"
                        [class.bg-emerald-600]="table.isAvailable && table.capacity >= guests()"
                        [class.bg-rose-700]="!table.isAvailable"
                        [class.bg-yellow-600]="table.isAvailable && table.capacity < guests()"
                        [class.ring-4]="isTableSelected(table)"
                        [class.ring-amber-500]="isTableSelected(table)"
                        [class.rounded-lg]="table.shape === 'square'"
                        [class.rounded-full]="table.shape === 'round'">
                        
                        <!-- Table Number -->
                        <div class="text-lg font-bold">{{ table.code || table.id }}</div>
                        <!-- Capacity -->
                        <div class="text-xs opacity-75">{{ table.capacity }}p</div>
                        
                        <!-- Selection indicator -->
                        @if(isTableSelected(table)) {
                          <div class="absolute -top-2 -right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center">
                            <span class="text-slate-900 text-xs font-bold">‚úì</span>
                          </div>
                        }
                      </div>
                      
                      <!-- Table Status -->
                      <div class="text-center mt-2">
                        @if (!table.isAvailable) {
                          <span class="text-xs text-rose-400 font-medium">Ocupada</span>
                        } @else if (table.capacity < guests()) {
                          <span class="text-xs text-yellow-400 font-medium">Muy peque√±a</span>
                        } @else {
                          <span class="text-xs text-emerald-400 font-medium">Disponible</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Legend -->
          <div class="mt-6 p-4 bg-slate-800 rounded-lg">
            <h4 class="text-sm font-semibold text-slate-300 mb-3">Leyenda:</h4>
            <div class="flex flex-wrap gap-4 text-xs">
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-emerald-600 rounded"></div>
                <span class="text-slate-300">Disponible</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-rose-700 rounded"></div>
                <span class="text-slate-300">Ocupada</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-600 rounded"></div>
                <span class="text-slate-300">Capacidad insuficiente</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-emerald-600 rounded ring-2 ring-amber-500"></div>
                <span class="text-slate-300">Mesa seleccionada</span>
              </div>
            </div>
          </div>
          
          <div class="mt-8 text-center">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
          </div>
        </div>
      }
      <!-- Step 4: Menu -->
      @case (4) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">4. Pre-ordena tu Comida (Opcional)</h2>
          <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
            @for(item of menu(); track item.id) {
              <div class="flex items-center justify-between bg-slate-700 p-4 rounded-lg gap-4">
                <div class="flex items-center gap-4 flex-grow">
                  @if(item.imageUrl) {
                    <img [src]="item.imageUrl" [alt]="item.name" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                  } @else {
                    <div class="w-20 h-20 bg-slate-600 rounded-md flex-shrink-0 flex items-center justify-center text-xs text-slate-400">Sin foto</div>
                  }
                  <div>
                    <h4 class="font-bold text-lg">{{ item.name }}</h4>
                    <p class="text-sm text-slate-400">{{ item.description }}</p>
                    <p class="text-amber-500 font-semibold mt-1">{{ item.price | currency }}</p>
                  </div>
                </div>
                <div class="flex items-center space-x-3 flex-shrink-0">
                  @if (getItemQuantity(item.id) > 0) {
                    <button (click)="removeMenuItemFromBooking(item.id)" class="w-8 h-8 rounded-full bg-slate-600 hover:bg-slate-500">-</button>
                    <span class="w-8 text-center font-bold">{{ getItemQuantity(item.id) }}</span>
                  }
                  <button (click)="addMenuItemToBooking(item)" class="w-8 h-8 rounded-full bg-amber-500 hover:bg-amber-400 text-slate-900">+</button>
                </div>
              </div>
            }
          </div>
          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            <button (click)="nextStep()" class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all">Continuar al Resumen</button>
          </div>
        </div>
      }
      <!-- Step 5: Summary -->
      @case (5) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">5. Resumen de la Reserva</h2>
          <div class="bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Datos del Titular:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Nombre:</span> <span class="font-bold">{{ customerName() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Email:</span> <span class="font-bold">{{ customerEmail() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Tel√©fono:</span> <span class="font-bold">{{ customerPhone() }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Detalles de la Reserva:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Fecha y Hora:</span> <span class="font-bold">{{ currentReservation().date }} a las {{ currentReservation().time }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Comensales:</span> <span class="font-bold">{{ currentReservation().guests }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Mesa:</span> <span class="font-bold">Mesa #{{ currentReservation().table?.id }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Pedido del Men√∫:</h4>
            @if(currentReservation().menuItems.length > 0) {
              @for(orderItem of currentReservation().menuItems; track orderItem.item.id) {
                <div class="flex justify-between">
                  <span>{{ orderItem.item.name }} x {{ orderItem.quantity }}</span>
                  <span>{{ (orderItem.item.price * orderItem.quantity) | currency }}</span>
                </div>
              }
              <hr class="border-slate-600">
              <div class="flex justify-between text-xl font-bold text-amber-500"><span>Costo Total:</span><span>{{ menuTotal() | currency }}</span></div>
            } @else {
              <p class="text-slate-400">No se pre-orden√≥ comida.</p>
            }
          </div>

          <div class="mt-6 bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Peticiones Especiales (Opcional)</h4>
            <div>              
              <textarea id="specialRequests" [value]="currentReservation().specialRequests" (input)="updateSpecialRequests($event)" rows="3" class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500" placeholder="Ej: Alergias, celebraci√≥n de cumplea√±os, etc."></textarea>
            </div>
          </div>

          @if(menuTotal() > 0) {
            <div class="mt-6">
              <label class="flex items-center">
                <input type="checkbox" [checked]="termsAccepted()" (change)="updateTerms($event)" class="h-4 w-4 rounded border-slate-500 bg-slate-600 text-amber-600 focus:ring-amber-500">
                <span class="ml-2 text-slate-300">Acepto los <button type="button" (click)="isTermsModalOpen.set(true)" class="text-amber-500 hover:underline inline font-medium">t√©rminos y condiciones</button> de la pre-orden.</span>
              </label>
            </div>
          }

          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            <button (click)="completeBooking()"
                    [disabled]="(menuTotal() > 0 && !termsAccepted()) || !currentReservation().customerName || !currentReservation().customerEmail"
                    class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed">
              @if(menuTotal() > 0) {
                <span>Confirmar y Pagar</span>
              } @else {
                <span>Confirmar Reserva</span>
              }
            </button>
          </div>
        </div>
      }
      <!-- Step 6: Payment Type Selection -->
      @case (6) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">üí≥ Forma de Pago</h2>
          <p class="text-slate-300 text-center mb-8">Elige c√≥mo prefieres realizar el pago de tu pre-orden</p>
          
          <!-- Payment Summary -->
          <div class="bg-slate-700 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold text-amber-500 mb-4">Resumen del Monto a Pagar</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-slate-300">Pre-orden de comida:</span>
                <span class="font-semibold">{{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
              <hr class="border-slate-600 my-3">
              <div class="flex justify-between text-xl font-bold text-amber-500">
                <span>Total a Pagar:</span>
                <span>{{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Payment Type Options -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Online Payment Option -->
            <div class="bg-slate-700 rounded-lg p-6 border-2 transition-all cursor-pointer hover:border-amber-500"
                 [class.border-amber-500]="paymentType() === 'online'"
                 [class.bg-amber-500/10]="paymentType() === 'online'"
                 (click)="selectPaymentType('online')">
              <div class="text-center">
                <div class="text-4xl mb-4">üí≥</div>
                <h3 class="text-xl font-bold text-slate-100 mb-3">Pago Online</h3>
                <p class="text-slate-300 mb-4">Paga ahora de forma segura con tu tarjeta de cr√©dito o d√©bito</p>
                <div class="bg-green-600 text-white py-2 px-4 rounded-full text-sm font-medium inline-block">
                  ‚úì Pago Inmediato
                </div>
              </div>
              <div class="mt-4 text-sm text-slate-400">
                <p>‚Ä¢ Procesamiento inmediato</p>
                <p>‚Ä¢ Confirmaci√≥n autom√°tica</p>
                <p>‚Ä¢ Sin necesidad de ir al local antes</p>
              </div>
            </div>

            <!-- Presential Payment Option -->
            <div class="bg-slate-700 rounded-lg p-6 border-2 transition-all cursor-pointer hover:border-amber-500"
                 [class.border-amber-500]="paymentType() === 'presencial'"
                 [class.bg-amber-500/10]="paymentType() === 'presencial'"
                 (click)="selectPaymentType('presencial')">
              <div class="text-center">
                <div class="text-4xl mb-4">üè™</div>
                <h3 class="text-xl font-bold text-slate-100 mb-3">Pago Presencial</h3>
                <p class="text-slate-300 mb-4">Paga cuando llegues al restaurante</p>
                <div class="bg-orange-600 text-white py-2 px-4 rounded-full text-sm font-medium inline-block">
                  üìÖ Pagar en Local
                </div>
              </div>
              <div class="mt-4 text-sm text-slate-400">
                <p>‚Ä¢ Pago en efectivo o tarjeta</p>
                <p>‚Ä¢ Debes llegar <strong class="text-orange-400">dentro de 24 horas</strong></p>
                <p>‚Ä¢ Confirma tu llegada al personal</p>
              </div>
            </div>
          </div>

          <!-- Important Notice for Presential Payment -->
          @if (paymentType() === 'presencial') {
            <div class="bg-orange-900 border border-orange-500 rounded-lg p-6 mb-6">
              <h4 class="text-lg font-semibold text-orange-200 mb-2">‚ö†Ô∏è Importante - Pago Presencial</h4>
              <div class="text-orange-300 space-y-2">
                <p>‚Ä¢ <strong>Debes acercarte al restaurante dentro de las pr√≥ximas 24 horas</strong> para confirmar y pagar tu reserva.</p>
                <p>‚Ä¢ La reserva quedar√° en estado <strong>PENDIENTE DE PAGO</strong> hasta tu llegada.</p>
                <p>‚Ä¢ Puedes pagar en efectivo o con tarjeta en el local.</p>
                <p>‚Ä¢ Si no confirmas el pago en 24 horas, tu reserva ser√° cancelada autom√°ticamente.</p>
              </div>
            </div>
          }

          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            @if (paymentType() === 'online') {
              <span class="text-slate-400 py-3 px-8">Procesando...</span>
            }
          </div>
        </div>
      }
      <!-- Step 7: Online Payment Details -->
      @case (7) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">üí≥ Detalles del Pago Online</h2>
          
          <!-- Payment Summary -->
          <div class="bg-slate-700 p-6 rounded-lg mb-6">
            <h3 class="text-xl font-semibold text-amber-500 mb-4">Resumen del Pago</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-slate-300">Reserva para:</span>
                <span class="font-semibold">{{ customerName() }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-300">Fecha y hora:</span>
                <span class="font-semibold">{{ selectedDate() }} a las {{ selectedTime() }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-300">Mesa:</span>
                <span class="font-semibold">Mesa #{{ currentReservation().table?.id }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-300">Comensales:</span>
                <span class="font-semibold">{{ guests() }} persona{{ guests() > 1 ? 's' : '' }}</span>
              </div>
              <hr class="border-slate-600 my-3">
              <div class="flex justify-between text-xl font-bold text-amber-500">
                <span>Total a Pagar:</span>
                <span>{{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>

          @if (paymentProcessing()) {
            <!-- Processing Payment -->
            <div class="bg-blue-900 p-6 rounded-lg text-center">
              <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
              <h3 class="text-xl font-semibold text-blue-200 mb-2">Procesando Pago...</h3>
              <p class="text-blue-300">Por favor espere mientras procesamos su pago de forma segura.</p>
            </div>
          } @else if (paymentError()) {
            <!-- Payment Error -->
            <div class="bg-red-900 p-6 rounded-lg mb-6">
              <h3 class="text-xl font-semibold text-red-200 mb-2">‚ùå Error en el Pago</h3>
              <p class="text-red-300">{{ paymentError() }}</p>
              <button 
                (click)="clearPaymentError()" 
                class="mt-4 bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">
                Intentar Nuevamente
              </button>
            </div>
          }

          <!-- Payment Form -->
          @if (!paymentProcessing()) {
            <div class="bg-slate-700 p-6 rounded-lg">
              <h3 class="text-xl font-semibold text-amber-500 mb-6">Informaci√≥n de la Tarjeta</h3>
              
              <div class="space-y-4">
                <!-- Card Number -->
                <div>
                  <label for="cardNumber" class="block text-sm font-medium text-slate-300 mb-2">
                    N√∫mero de Tarjeta *
                  </label>
                  <div class="relative">
                    <input 
                      type="text" 
                      id="cardNumber" 
                      [ngModel]="cardNumber()" 
                      (ngModelChange)="updateCardNumber($event)"
                      placeholder="1234 5678 9012 3456"
                      maxlength="19"
                      class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500"
                      [class.border-red-500]="cardNumber() && !isCardNumberValid()"
                      [class.border-green-500]="cardNumber() && isCardNumberValid()">
                    <div class="absolute right-3 top-3 text-sm text-slate-400">
                      {{ getCardType() }}
                    </div>
                  </div>
                  @if (cardNumber() && !isCardNumberValid()) {
                    <p class="text-red-400 text-sm mt-1">N√∫mero de tarjeta inv√°lido</p>
                  }
                </div>

                <!-- Expiration and CVV -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="expirationMonth" class="block text-sm font-medium text-slate-300 mb-2">
                      Mes de Vencimiento *
                    </label>
                    <select 
                      id="expirationMonth" 
                      [ngModel]="expirationMonth()" 
                      (ngModelChange)="expirationMonth.set($event)"
                      class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                      <option value="">Mes</option>
                      @for(month of months; track month.value) {
                        <option [value]="month.value">{{ month.label }}</option>
                      }
                    </select>
                  </div>

                  <div>
                    <label for="expirationYear" class="block text-sm font-medium text-slate-300 mb-2">
                      A√±o de Vencimiento *
                    </label>
                    <select 
                      id="expirationYear" 
                      [ngModel]="expirationYear()" 
                      (ngModelChange)="expirationYear.set($event)"
                      class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                      <option value="">A√±o</option>
                      @for(year of years; track year) {
                        <option [value]="year">{{ year }}</option>
                      }
                    </select>
                  </div>
                </div>

                <div>
                  <label for="cvv" class="block text-sm font-medium text-slate-300 mb-2">
                    CVV/CVC *
                  </label>
                  <input 
                    type="text" 
                    id="cvv" 
                    [ngModel]="cvv()" 
                    (ngModelChange)="cvv.set($event)"
                    placeholder="123"
                    maxlength="4"
                    class="w-32 bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500"
                    [class.border-red-500]="cvv() && !isCvvValid()"
                    [class.border-green-500]="cvv() && isCvvValid()">
                  @if (cvv() && !isCvvValid()) {
                    <p class="text-red-400 text-sm mt-1">CVV inv√°lido</p>
                  }
                </div>

                <!-- Security Notice -->
                <div class="bg-slate-800 p-4 rounded-lg border border-slate-600">
                  <div class="flex items-start space-x-3">
                    <div class="text-green-500 mt-1">üîí</div>
                    <div>
                      <h4 class="font-semibold text-slate-200 mb-1">Pago Seguro</h4>
                      <p class="text-slate-400 text-sm">
                        Tu informaci√≥n de pago est√° protegida con encriptaci√≥n SSL de 256 bits. 
                        Utilizamos Culqi, una pasarela de pagos certificada y segura.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Test Cards Info (only in development) -->
                <div class="bg-blue-900 p-4 rounded-lg">
                  <h4 class="font-semibold text-blue-200 mb-2">üí° Tarjetas de Prueba</h4>
                  <div class="text-blue-300 text-sm space-y-1">
                    <p><strong>Visa:</strong> 4111 1111 1111 1111</p>
                    <p><strong>Mastercard:</strong> 5111 1111 1111 1118</p>
                    <p><strong>CVV:</strong> Cualquier 3 d√≠gitos</p>
                    <p><strong>Fecha:</strong> Cualquier fecha futura</p>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Action Buttons -->
          @if (!paymentProcessing()) {
            <div class="mt-8 flex justify-center gap-4">
              <button 
                (click)="prevStep()" 
                class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">
                ü†¨ Atr√°s
              </button>
              <button 
                (click)="processPaymentWithCulqi()" 
                [disabled]="!isPaymentFormValid()"
                class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-full hover:bg-emerald-600 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
                üí≥ Pagar {{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}
              </button>
            </div>
          }
        </div>
      }
    }
  </div>
</div>

<app-modal [isOpen]="isTermsModalOpen()" title="T√©rminos y Condiciones de Pre-orden" (closeModal)="isTermsModalOpen.set(false)">
  <div class="space-y-4 text-slate-300 max-h-[60vh] overflow-y-auto pr-4 text-sm">
    <h4 class="font-bold text-slate-100 text-base">1. Pre-orden y Pago</h4>
    <p>Al pre-ordenar un men√∫, usted acepta pagar el monto total indicado en el resumen de la reserva. El pago se procesar√° a trav√©s de nuestra pasarela de pagos segura. Este pago garantiza la preparaci√≥n de sus platos y no es reembolsable.</p>
    
    <h4 class="font-bold text-slate-100 text-base">2. Pol√≠tica de Cancelaci√≥n</h4>
    <p>La reserva de la mesa puede ser cancelada hasta 24 horas antes de la hora programada sin penalizaci√≥n. Sin embargo, el costo de la comida pre-ordenada no es reembolsable, ya que los ingredientes se adquieren y preparan con antelaci√≥n.</p>
    
    <h4 class="font-bold text-slate-100 text-base">3. Puntualidad</h4>
    <p>Le solicitamos llegar a tiempo a su reserva. Mantendremos su mesa por un per√≠odo de gracia de 15 minutos. Pasado este tiempo, la mesa podr√≠a ser asignada a otros clientes y su pre-orden ser√° mantenida para cuando usted llegue, aunque no podemos garantizarle una mesa de inmediato.</p>

    <h4 class="font-bold text-slate-100 text-base">4. Cambios en la Reserva</h4>
    <p>Cualquier cambio en el n√∫mero de comensales o en la hora de la reserva debe ser notificado con al menos 6 horas de antelaci√≥n y est√° sujeto a disponibilidad. No se pueden realizar cambios en los platos pre-ordenados una vez confirmada la reserva.</p>
    
    <h4 class="font-bold text-slate-100 text-base">5. Alergias y Restricciones Diet√©ticas</h4>
    <p>Es responsabilidad del cliente informar sobre cualquier alergia o restricci√≥n diet√©tica en la secci√≥n de "Peticiones Especiales". Marakos Grill har√° todo lo posible por acomodar sus necesidades, pero no se hace responsable de reacciones adversas si no se ha notificado previamente.</p>
  </div>
</app-modal>