<div class="max-w-4xl mx-auto bg-slate-800 rounded-lg shadow-2xl shadow-black/30 overflow-hidden">
  <!-- Progress Bar -->
  <div class="p-6 border-b border-slate-700">
    <div class="flex items-center justify-between">
      @for(stepInfo of ['Datos', 'Disponibilidad', 'Mesa', 'Men√∫', 'Resumen', 'Pago']; track stepInfo; let i = $index) {
        <div class="flex items-center" [class.opacity-50]="step() < i + 1">
          <div class="flex items-center justify-center w-10 h-10 rounded-full" [class]="step() >= i + 1 ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-400'">
            <span class="font-bold">{{ i + 1 }}</span>
          </div>
          <span class="ml-3 font-medium" [class]="step() >= i + 1 ? 'text-amber-500' : 'text-slate-400'">
            {{ stepInfo }}
          </span>
        </div>
        @if (i < 5) {
          <div class="flex-auto border-t-2 mx-4" [class]="step() > i + 1 ? 'border-amber-500' : 'border-slate-700'"></div>
        }
      }
    </div>
  </div>

  <div class="p-8">
    @switch (step()) {
      <!-- Step 1: Customer Details -->
      @case (1) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üçΩÔ∏è Reserva tu Mesa</h2>
          <p class="text-slate-300 text-center mb-8">Disfruta de un momento especial!</p>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Current User Info -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">üë• Usuario</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- TODO: Replace with actual user service data when backend is ready -->
                <div class="space-y-4">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Nombre:</span>
                    <span class="font-semibold">{{ currentUser()?.name || 'Usuario Mockeado' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Email:</span>
                    <span class="font-semibold">{{ currentUser()?.email || 'usuario@marakos.com' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Tipo:</span>
                    <span class="font-semibold">{{ currentUser()?.role || 'Cliente' }}</span>
                  </div>
                </div>
                <div class="mt-4 p-3 bg-blue-900 rounded-lg">
                  <p class="text-blue-200 text-sm">
                    üí° Puedes hacer la reserva para otra persona modificando los datos del titular
                  </p>
                </div>
              </div>
            </div>

            <!-- Reservation Holder Details -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">‚úèÔ∏è Datos del Titular</h3>
              <div class="space-y-4">
                <div>
                  <label for="customerName" class="block text-sm font-medium text-slate-300 mb-2">Nombre Completo *</label>
                  <input 
                    type="text" 
                    id="customerName" 
                    [ngModel]="customerName()" 
                    (ngModelChange)="updateCustomerField('name', $event)"
                    placeholder="Ingresa el nombre completo"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerEmail" class="block text-sm font-medium text-slate-300 mb-2">Email *</label>
                  <input 
                    type="email" 
                    id="customerEmail" 
                    [ngModel]="customerEmail()" 
                    (ngModelChange)="updateCustomerField('email', $event)"
                    placeholder="ejemplo@correo.com"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerPhone" class="block text-sm font-medium text-slate-300 mb-2">Tel√©fono *</label>
                  <input 
                    type="tel" 
                    id="customerPhone" 
                    [ngModel]="customerPhone()" 
                    (ngModelChange)="updateCustomerField('phone', $event)"
                    placeholder="+51 999 888 777"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 text-center">
            <button 
              (click)="nextStep()" 
              [disabled]="!canProceedFromStep1()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 2: Date, Time, Guests -->
      @case (2) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üìÖ Elige la fecha y hora</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Calendar -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">Selecciona la Fecha</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-4">
                  <button (click)="previousMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Äπ</span>
                  </button>
                  <h4 class="text-lg font-semibold">{{ getMonthName() }} {{ currentCalendarYear() }}</h4>
                  <button (click)="nextMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Ä∫</span>
                  </button>
                </div>

                <!-- Days of week -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  @for(day of ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b']; track day) {
                    <div class="text-center text-sm font-medium text-slate-400 p-2">{{ day }}</div>
                  }
                </div>

                <!-- Calendar Days -->
                <div class="grid grid-cols-7 gap-1">
                  @for(day of getCalendarDays(); track day) {
                    <button 
                      (click)="selectCalendarDate(day)"
                      [disabled]="!isDateAvailable(day)"
                      class="p-3 text-sm rounded-lg transition-all duration-200"
                      [class.bg-amber-500]="isDateSelected(day)"
                      [class.text-slate-900]="isDateSelected(day)"
                      [class.font-bold]="isDateSelected(day)"
                      [class.bg-emerald-600]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.hover:bg-emerald-500]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.text-white]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.bg-slate-600]="!isDateAvailable(day)"
                      [class.text-slate-500]="!isDateAvailable(day)"
                      [class.cursor-not-allowed]="!isDateAvailable(day)">
                      {{ day || '' }}
                    </button>
                  }
                </div>
              </div>
            </div>

            <!-- Time and Guests Selection -->
            <div class="space-y-6">
              <!-- Guest Count -->
              <div>
                <label for="guests" class="block text-xl font-semibold text-amber-500 mb-4">üë• N√∫mero de Comensales</label>
                <select id="guests" [ngModel]="guests()" (ngModelChange)="guests.set($event)" class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                  @for(i of [1,2,3,4,5,6,7,8]; track i) { <option [value]="i">{{ i }} Comensal{{ i > 1 ? 'es' : '' }}</option> }
                </select>
              </div>

              <!-- Time Selection -->
              <div>
                <label for="time" class="block text-xl font-semibold text-amber-500 mb-4">üïê Hora de la Reserva</label>
                <div class="grid grid-cols-2 gap-3">
                  @for(timeSlot of availableTimes(); track timeSlot.time) {
                    <button 
                      (click)="selectedTime.set(timeSlot.time)"
                      [disabled]="!timeSlot.available"
                      class="p-3 rounded-lg border-2 transition-all duration-300 text-sm"
                      [class.bg-amber-500]="selectedTime() === timeSlot.time"
                      [class.border-amber-500]="selectedTime() === timeSlot.time"
                      [class.text-slate-900]="selectedTime() === timeSlot.time"
                      [class.bg-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.border-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.text-white]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.hover:bg-emerald-500]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.bg-slate-600]="!timeSlot.available"
                      [class.border-slate-600]="!timeSlot.available"
                      [class.text-slate-500]="!timeSlot.available"
                      [class.cursor-not-allowed]="!timeSlot.available">
                      {{ timeSlot.label }}
                      @if (!timeSlot.available) {
                        <div class="text-xs opacity-75">No disponible</div>
                      }
                    </button>
                  }
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 flex justify-center gap-4">
            <button 
              (click)="prevStep()" 
              class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">
              ü†¨ Atr√°s
            </button>
            <button 
              (click)="checkAvailability()" 
              [disabled]="!canProceedFromStep2()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 3: Select Table -->
      @case (3) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">3. Selecciona tu Mesa</h2>
          <div class="p-6 bg-slate-900 rounded-lg">
            <div class="grid grid-cols-4 gap-4">
              @for(table of tables(); track table.id) {
                <div 
                  class="flex items-center justify-center h-20 w-20 text-slate-100 font-bold transition-all duration-300"
                  [class.bg-emerald-600]="table.isAvailable"
                  [class.bg-rose-700]="!table.isAvailable"
                  [class.opacity-50]="!table.isAvailable || table.capacity < guests()"
                  [class.cursor-pointer]="table.isAvailable && table.capacity >= guests()"
                  [class.cursor-not-allowed]="!table.isAvailable || table.capacity < guests()"
                  [class.ring-4]="isTableSelected(table)"
                  [class.ring-amber-500]="isTableSelected(table)"
                  [class.rounded-lg]="table.shape === 'square'"
                  [class.rounded-full]="table.shape === 'round'"
                  (click)="selectTable(table)">
                  T{{ table.id }} ({{ table.capacity }})
                </div>
              }
            </div>
          </div>
          <div class="mt-8 text-center">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
          </div>
        </div>
      }
      <!-- Step 4: Menu -->
      @case (4) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">4. Pre-ordena tu Comida (Opcional)</h2>
          <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
            @for(item of menu(); track item.id) {
              <div class="flex items-center justify-between bg-slate-700 p-4 rounded-lg gap-4">
                <div class="flex items-center gap-4 flex-grow">
                  @if(item.imageUrl) {
                    <img [src]="item.imageUrl" [alt]="item.name" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                  } @else {
                    <div class="w-20 h-20 bg-slate-600 rounded-md flex-shrink-0 flex items-center justify-center text-xs text-slate-400">Sin foto</div>
                  }
                  <div>
                    <h4 class="font-bold text-lg">{{ item.name }}</h4>
                    <p class="text-sm text-slate-400">{{ item.description }}</p>
                    <p class="text-amber-500 font-semibold mt-1">{{ item.price | currency }}</p>
                  </div>
                </div>
                <div class="flex items-center space-x-3 flex-shrink-0">
                  @if (getItemQuantity(item.id) > 0) {
                    <button (click)="removeMenuItemFromBooking(item.id)" class="w-8 h-8 rounded-full bg-slate-600 hover:bg-slate-500">-</button>
                    <span class="w-8 text-center font-bold">{{ getItemQuantity(item.id) }}</span>
                  }
                  <button (click)="addMenuItemToBooking(item)" class="w-8 h-8 rounded-full bg-amber-500 hover:bg-amber-400 text-slate-900">+</button>
                </div>
              </div>
            }
          </div>
          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            <button (click)="nextStep()" class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all">Continuar al Resumen</button>
          </div>
        </div>
      }
      <!-- Step 5: Summary -->
      @case (5) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">5. Resumen de la Reserva</h2>
          <div class="bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Datos del Titular:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Nombre:</span> <span class="font-bold">{{ customerName() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Email:</span> <span class="font-bold">{{ customerEmail() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Tel√©fono:</span> <span class="font-bold">{{ customerPhone() }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Detalles de la Reserva:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Fecha y Hora:</span> <span class="font-bold">{{ currentReservation().date }} a las {{ currentReservation().time }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Comensales:</span> <span class="font-bold">{{ currentReservation().guests }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Mesa:</span> <span class="font-bold">Mesa #{{ currentReservation().table?.id }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Pedido del Men√∫:</h4>
            @if(currentReservation().menuItems.length > 0) {
              @for(orderItem of currentReservation().menuItems; track orderItem.item.id) {
                <div class="flex justify-between">
                  <span>{{ orderItem.item.name }} x {{ orderItem.quantity }}</span>
                  <span>{{ (orderItem.item.price * orderItem.quantity) | currency }}</span>
                </div>
              }
              <hr class="border-slate-600">
              <div class="flex justify-between text-xl font-bold text-amber-500"><span>Costo Total:</span><span>{{ menuTotal() | currency }}</span></div>
            } @else {
              <p class="text-slate-400">No se pre-orden√≥ comida.</p>
            }
          </div>

          <div class="mt-6 bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Peticiones Especiales (Opcional)</h4>
            <div>              
              <textarea id="specialRequests" [value]="currentReservation().specialRequests" (input)="updateSpecialRequests($event)" rows="3" class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500" placeholder="Ej: Alergias, celebraci√≥n de cumplea√±os, etc."></textarea>
            </div>
          </div>

          @if(menuTotal() > 0) {
            <div class="mt-6">
              <label class="flex items-center">
                <input type="checkbox" [checked]="termsAccepted()" (change)="updateTerms($event)" class="h-4 w-4 rounded border-slate-500 bg-slate-600 text-amber-600 focus:ring-amber-500">
                <span class="ml-2 text-slate-300">Acepto los <button type="button" (click)="isTermsModalOpen.set(true)" class="text-amber-500 hover:underline inline font-medium">t√©rminos y condiciones</button> de la pre-orden.</span>
              </label>
            </div>
          }

          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            <button (click)="completeBooking()"
                    [disabled]="(menuTotal() > 0 && !termsAccepted()) || !currentReservation().customerName || !currentReservation().customerEmail"
                    class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed">
              @if(menuTotal() > 0) {
                <span>Confirmar y Pagar</span>
              } @else {
                <span>Confirmar Reserva</span>
              }
            </button>
          </div>
        </div>
      }
      <!-- Step 6: Payment -->
      @case (6) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">6. Detalles del Pago</h2>
          <div class="bg-slate-700 p-6 rounded-lg space-y-4">
            <div class="flex justify-between text-xl font-bold text-amber-500">
                <span>Monto a Pagar:</span><span>{{ menuTotal() | currency }}</span>
            </div>
            <div class="mt-6">
              <label class="block text-sm font-medium text-slate-300 mb-2">M√©todo de Pago</label>
              <div class="flex space-x-4">
                <button (click)="paymentMethod.set('Tarjeta')" class="flex-1 p-4 rounded-lg border-2 transition" [class.bg-amber-500]="paymentMethod() === 'Tarjeta'" [class.border-amber-500]="paymentMethod() === 'Tarjeta'" [class.border-slate-600]="paymentMethod() !== 'Tarjeta'">Tarjeta</button>
                <button (click)="paymentMethod.set('Efectivo')" class="flex-1 p-4 rounded-lg border-2 transition" [class.bg-amber-500]="paymentMethod() === 'Efectivo'" [class.border-amber-500]="paymentMethod() === 'Efectivo'" [class.border-slate-600]="paymentMethod() !== 'Efectivo'">Efectivo (Pagar en el restaurante)</button>
              </div>
            </div>
            @if(paymentMethod() === 'Tarjeta') {
              <div class="mt-4 space-y-4 animate-fade-in">
                <input type="text" placeholder="N√∫mero de Tarjeta" class="w-full bg-slate-600 p-3 rounded-md">
                <div class="flex space-x-4">
                  <input type="text" placeholder="MM/AA" class="w-1/2 bg-slate-600 p-3 rounded-md">
                  <input type="text" placeholder="CVC" class="w-1/2 bg-slate-600 p-3 rounded-md">
                </div>
              </div>
            }
          </div>
          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">Atr√°s</button>
            <button (click)="processPayment()" [disabled]="!paymentMethod()" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-full hover:bg-emerald-600 transition-all disabled:bg-slate-600">Finalizar</button>
          </div>
        </div>
      }
    }
  </div>
</div>

<app-modal [isOpen]="isTermsModalOpen()" title="T√©rminos y Condiciones de Pre-orden" (closeModal)="isTermsModalOpen.set(false)">
  <div class="space-y-4 text-slate-300 max-h-[60vh] overflow-y-auto pr-4 text-sm">
    <h4 class="font-bold text-slate-100 text-base">1. Pre-orden y Pago</h4>
    <p>Al pre-ordenar un men√∫, usted acepta pagar el monto total indicado en el resumen de la reserva. El pago se procesar√° a trav√©s de nuestra pasarela de pagos segura. Este pago garantiza la preparaci√≥n de sus platos y no es reembolsable.</p>
    
    <h4 class="font-bold text-slate-100 text-base">2. Pol√≠tica de Cancelaci√≥n</h4>
    <p>La reserva de la mesa puede ser cancelada hasta 24 horas antes de la hora programada sin penalizaci√≥n. Sin embargo, el costo de la comida pre-ordenada no es reembolsable, ya que los ingredientes se adquieren y preparan con antelaci√≥n.</p>
    
    <h4 class="font-bold text-slate-100 text-base">3. Puntualidad</h4>
    <p>Le solicitamos llegar a tiempo a su reserva. Mantendremos su mesa por un per√≠odo de gracia de 15 minutos. Pasado este tiempo, la mesa podr√≠a ser asignada a otros clientes y su pre-orden ser√° mantenida para cuando usted llegue, aunque no podemos garantizarle una mesa de inmediato.</p>

    <h4 class="font-bold text-slate-100 text-base">4. Cambios en la Reserva</h4>
    <p>Cualquier cambio en el n√∫mero de comensales o en la hora de la reserva debe ser notificado con al menos 6 horas de antelaci√≥n y est√° sujeto a disponibilidad. No se pueden realizar cambios en los platos pre-ordenados una vez confirmada la reserva.</p>
    
    <h4 class="font-bold text-slate-100 text-base">5. Alergias y Restricciones Diet√©ticas</h4>
    <p>Es responsabilidad del cliente informar sobre cualquier alergia o restricci√≥n diet√©tica en la secci√≥n de "Peticiones Especiales". Marakos Grill har√° todo lo posible por acomodar sus necesidades, pero no se hace responsable de reacciones adversas si no se ha notificado previamente.</p>
  </div>
</app-modal>