<div class="max-w-4xl mx-auto bg-slate-800 rounded-lg shadow-2xl shadow-black/30 overflow-hidden">
  <!-- Progress Bar -->
  <div class="p-6 border-b border-slate-700">
    <div class="flex items-center justify-between">
      @for(stepInfo of ['Datos', 'Disponibilidad', 'Mesa', 'Men√∫', 'Resumen', 'Pago']; track $index; let i = $index) {
        <div class="flex items-center" [class.opacity-50]="step() < i + 1">
          <div class="flex items-center justify-center w-10 h-10 rounded-full" [class]="step() >= i + 1 ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-400'">
            <span class="font-bold">{{ i + 1 }}</span>
          </div>
          <span class="ml-3 font-medium" [class]="step() >= i + 1 ? 'text-amber-500' : 'text-slate-400'">
            {{ stepInfo }}
          </span>
        </div>
        @if (i < 5) {
          <div class="flex-auto border-t-2 mx-4" [class]="step() > i + 1 ? 'border-amber-500' : 'border-slate-700'"></div>
        }
      }
    </div>
  </div>

  <div class="p-8">
    @switch (step()) {
      <!-- Step 1: Customer Details -->
      @case (1) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üçΩÔ∏è Reserva tu Mesa</h2>
          <p class="text-slate-300 text-center mb-8">Disfruta de un momento especial!</p>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Current User Info -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">üë• Usuario</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- TODO: Replace with actual user service data when backend is ready -->
                <div class="space-y-4">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Nombre:</span>
                    <span class="font-semibold">{{ currentUser()?.nombre + ' ' + currentUser()?.apellido || 'Usuario Mockeado' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Email:</span>
                    <span class="font-semibold">{{ currentUser()?.email || 'usuario@marakos.com' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Tipo:</span>
                    <span class="font-semibold">{{ currentUser()?.tipoUsuario || 'Cliente' }}</span>
                  </div>
                </div>
                <div class="mt-4 p-3 bg-blue-900 rounded-lg">
                  <p class="text-blue-200 text-sm">
                    üí° Puedes hacer la reserva para otra persona modificando los datos del titular
                  </p>
                </div>
              </div>
            </div>

            <!-- Reservation Holder Details -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">‚úèÔ∏è Datos del Titular</h3>
              <div class="space-y-4">
                <!-- Document Type Selection -->
                <div>
                  <label class="block text-sm font-medium text-slate-300 mb-2">Tipo de Documento *</label>
                  <div class="flex gap-4">
                    <button
                      type="button"
                      (click)="selectDocumentType('DNI')"
                      [class.bg-amber-500]="documentType() === 'DNI'"
                      [class.text-slate-900]="documentType() === 'DNI'"
                      [class.bg-slate-700]="documentType() !== 'DNI'"
                      [class.text-slate-300]="documentType() !== 'DNI'"
                      class="flex-1 py-3 px-6 rounded-md font-semibold transition-all hover:bg-amber-400 hover:text-slate-900">
                      DNI
                    </button>
                    <button
                      type="button"
                      (click)="selectDocumentType('CEX')"
                      [class.bg-amber-500]="documentType() === 'CEX'"
                      [class.text-slate-900]="documentType() === 'CEX'"
                      [class.bg-slate-700]="documentType() !== 'CEX'"
                      [class.text-slate-300]="documentType() !== 'CEX'"
                      class="flex-1 py-3 px-6 rounded-md font-semibold transition-all hover:bg-amber-400 hover:text-slate-900">
                      CEX
                    </button>
                  </div>
                </div>

                <!-- Document Number Input -->
                <div>
                  <label for="customerDocument" class="block text-sm font-medium text-slate-300 mb-2">
                    N√∫mero de Documento *
                  </label>
                  <input 
                    type="text" 
                    id="customerDocument" 
                    [ngModel]="customerDocument()" 
                    (input)="onDocumentInput($event)"
                    (blur)="onDocumentBlur()"
                    [placeholder]="documentType() === 'DNI' ? '12345678 (8 d√≠gitos)' : documentType() === 'CEX' ? 'A1B2C3D4E (9 caracteres)' : 'Seleccione tipo de documento'"
                    [disabled]="!documentType()"
                    [class.border-red-500]="documentError()"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500 disabled:opacity-50 disabled:cursor-not-allowed">
                  @if (documentError()) {
                    <p class="mt-1 text-sm text-red-400">{{ documentError() }}</p>
                  }
                  @if (documentType() && !documentError()) {
                    <p class="mt-1 text-xs text-slate-400">
                      @if (documentType() === 'DNI') {
                        DNI: Debe tener exactamente 8 d√≠gitos num√©ricos
                      } @else if (documentType() === 'CEX') {
                        CEX: Debe tener exactamente 9 caracteres alfanum√©ricos
                      }
                    </p>
                  }
                </div>

                <div>
                  <label for="customerName" class="block text-sm font-medium text-slate-300 mb-2">Nombre Completo *</label>
                  <input 
                    type="text" 
                    id="customerName" 
                    [ngModel]="customerName()" 
                    (ngModelChange)="updateCustomerField('name', $event)"
                    placeholder="Ingresa el nombre completo"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerEmail" class="block text-sm font-medium text-slate-300 mb-2">Email *</label>
                  <input 
                    type="email" 
                    id="customerEmail" 
                    [ngModel]="customerEmail()" 
                    (ngModelChange)="updateCustomerField('email', $event)"
                    placeholder="ejemplo@correo.com"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
                
                <div>
                  <label for="customerPhone" class="block text-sm font-medium text-slate-300 mb-2">Tel√©fono *</label>
                  <input 
                    type="tel" 
                    id="customerPhone" 
                    [ngModel]="customerPhone()" 
                    (ngModelChange)="updateCustomerField('phone', $event)"
                    placeholder="+51 999 888 777"
                    class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 text-center">
            <button 
              (click)="nextStep()" 
              [disabled]="!canProceedFromStep1()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 2: Date, Time, Guests -->
      @case (2) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6 text-center">üìÖ Elige la fecha y hora</h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Calendar -->
            <div>
              <h3 class="text-xl font-semibold text-amber-500 mb-4">Selecciona la Fecha</h3>
              <div class="bg-slate-700 rounded-lg p-6">
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-4">
                  <button (click)="previousMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Äπ</span>
                  </button>
                  <h4 class="text-lg font-semibold">{{ getMonthName() }} {{ currentCalendarYear() }}</h4>
                  <button (click)="nextMonth()" class="p-2 rounded-full hover:bg-slate-600 transition-colors">
                    <span class="text-xl">‚Ä∫</span>
                  </button>
                </div>

                <!-- Days of week -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                  @for(day of ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b']; track day) {
                    <div class="text-center text-sm font-medium text-slate-400 p-2">{{ day }}</div>
                  }
                </div>

                <!-- Calendar Days -->
                <div class="grid grid-cols-7 gap-1">
                  @for(day of getCalendarDays(); track $index; let i = $index) {
                    <button 
                      (click)="selectCalendarDate(day)"
                      [disabled]="!isDateAvailable(day)"
                      class="p-3 text-sm rounded-lg transition-all duration-200"
                      [class.bg-amber-500]="isDateSelected(day)"
                      [class.text-slate-900]="isDateSelected(day)"
                      [class.font-bold]="isDateSelected(day)"
                      [class.bg-emerald-600]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.hover:bg-emerald-500]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.text-white]="isDateAvailable(day) && !isDateSelected(day)"
                      [class.bg-slate-600]="!isDateAvailable(day)"
                      [class.text-slate-500]="!isDateAvailable(day)"
                      [class.cursor-not-allowed]="!isDateAvailable(day)">
                      {{ day || '' }}
                    </button>
                  }
                </div>
              </div>
            </div>

            <!-- Time and Guests Selection -->
            <div class="space-y-6">
              <!-- Guest Count -->
              <div>
                <label for="guests" class="block text-xl font-semibold text-amber-500 mb-4">üë• N√∫mero de Comensales</label>
                <select id="guests" [ngModel]="guests()" (ngModelChange)="guests.set($event)" class="w-full bg-slate-700 border-slate-600 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500">
                  @for(i of [1,2,3,4,5,6,7,8]; track i) { <option [value]="i">{{ i }} Comensal{{ i > 1 ? 'es' : '' }}</option> }
                </select>
              </div>

              <!-- Time Selection -->
              <div>
                <label for="time" class="block text-xl font-semibold text-amber-500 mb-4">üïê Hora de la Reserva</label>
                
                @if(loadingAvailability()) {
                  <div class="flex flex-col items-center justify-center py-12 space-y-4">
                    <svg class="animate-spin h-12 w-12 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <div class="text-center">
                      <p class="text-slate-300 font-medium">Cargando horarios disponibles...</p>
                      <p class="text-slate-400 text-sm mt-1">Esto puede tomar unos segundos</p>
                    </div>
                  </div>
                } @else if(!selectedDate()) {
                  <div class="flex flex-col items-center justify-center py-12 space-y-3">
                    <div class="text-5xl">üìÖ</div>
                    <div class="text-center">
                      <p class="text-slate-300 font-medium text-lg">Selecciona una fecha para verificar la disponibilidad horaria</p>
                      <p class="text-slate-400 text-sm mt-2">Elige una fecha del calendario para ver los horarios disponibles</p>
                    </div>
                  </div>
                } @else if(availableTimes().length === 0 && selectedDate()) {
                  <div class="text-center py-8 text-slate-400">
                    <p class="text-lg">No hay horarios disponibles para esta fecha</p>
                    <p class="text-sm mt-2">Por favor, selecciona otra fecha</p>
                  </div>
                } @else {
                  <div class="grid grid-cols-2 gap-3">
                  @for(timeSlot of availableTimes(); track timeSlot.time) {
                    <button 
                      (click)="selectedTime.set(timeSlot.time)"
                      [disabled]="!timeSlot.available"
                      class="p-3 rounded-lg border-2 transition-all duration-300 text-sm"
                      [class.bg-amber-500]="selectedTime() === timeSlot.time"
                      [class.border-amber-500]="selectedTime() === timeSlot.time"
                      [class.text-slate-900]="selectedTime() === timeSlot.time"
                      [class.bg-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.border-emerald-600]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.text-white]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.hover:bg-emerald-500]="timeSlot.available && selectedTime() !== timeSlot.time"
                      [class.bg-slate-600]="!timeSlot.available"
                      [class.border-slate-600]="!timeSlot.available"
                      [class.text-slate-500]="!timeSlot.available"
                      [class.cursor-not-allowed]="!timeSlot.available">
                      {{ timeSlot.label }}
                      @if (!timeSlot.available) {
                        <div class="text-xs opacity-75">No disponible</div>
                      }
                    </button>
                  }
                  </div>
                }
              </div>
            </div>
          </div>
          
          <div class="mt-8 flex justify-center gap-4">
            <button 
              (click)="prevStep()" 
              class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">
              ü†¨ Atr√°s
            </button>
            <button 
              (click)="checkAvailability()" 
              [disabled]="!canProceedFromStep2()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 3: Select Table -->
      @case (3) {
        <div class="animate-fade-in">
          <h2 class="text-2xl font-bold text-slate-100 mb-2 text-center">3. Selecciona tu Mesa</h2>
          
          @if (!selectedTable()) {
            <p class="text-center text-slate-400 mb-4 text-sm">üìç Haz clic en una mesa disponible para continuar</p>
          } @else {
            <p class="text-center text-amber-400 mb-4 text-sm font-medium">‚úì Mesa {{ selectedTable()!.code || selectedTable()!.id }} seleccionada</p>
          }
          
          <!-- Info Cards Row -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <!-- Selected Table Info -->
            @if (selectedTable()) {
              <div class="p-3 bg-gradient-to-br from-amber-500/20 to-amber-600/10 rounded-lg border-2 border-amber-500">
                <h4 class="text-sm font-bold text-amber-400 mb-2 flex items-center">
                  <span class="mr-1">‚úì</span> Detalles
                </h4>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span class="text-slate-300">Mesa:</span>
                    <span class="font-semibold text-white">{{ selectedTable()!.code || selectedTable()!.id }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-300">Ubicaci√≥n:</span>
                    <span class="font-semibold text-white">{{ selectedTable()!.location }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-300">Capacidad:</span>
                    <span class="font-semibold text-white">{{ selectedTable()!.capacity }}p</span>
                  </div>
                </div>
              </div>
            }

            <!-- Reservation Summary -->
            <div class="p-3 bg-slate-900 rounded-lg border border-slate-700">
              <h4 class="text-xs font-bold text-slate-300 mb-2">Resumen</h4>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span class="text-slate-400">Fecha:</span>
                  <span class="font-medium text-slate-200">{{ selectedDate() }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Hora:</span>
                  <span class="font-medium text-slate-200">{{ selectedTime() }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-400">Comensales:</span>
                  <span class="font-medium text-slate-200">{{ guests() }}p</span>
                </div>
              </div>
            </div>

            <!-- Legend -->
            <div class="p-3 bg-slate-900 rounded-lg border border-slate-700">
              <h4 class="text-xs font-bold text-slate-300 mb-2">Leyenda</h4>
              <div class="grid grid-cols-2 gap-2 text-[10px]">
                <div class="flex items-center gap-1">
                  <div class="w-2.5 h-2.5 bg-emerald-600 rounded"></div>
                  <span class="text-slate-300">Disponible</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-2.5 h-2.5 bg-rose-700 rounded"></div>
                  <span class="text-slate-300">Ocupada</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-2.5 h-2.5 bg-yellow-600 rounded"></div>
                  <span class="text-slate-300">Peque√±a</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-2.5 h-2.5 bg-emerald-600 rounded ring-2 ring-amber-500"></div>
                  <span class="text-slate-300">Elegida</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Table Selection: 2 Column Layout -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            @for(location of getLocationGroups(); track location.name) {
              <div class="p-3 rounded-lg border border-slate-700 relative overflow-hidden"
                   [class.bg-gradient-to-br]="true"
                   [class.from-slate-900]="true"
                   [class.via-slate-900]="true"
                   [class.to-emerald-900/20]="location.name.toLowerCase().includes('jardin') || location.name.toLowerCase().includes('terraza')"
                   [class.to-amber-900/20]="location.name.toLowerCase().includes('central') || location.name.toLowerCase().includes('principal')"
                   [class.to-blue-900/20]="location.name.toLowerCase().includes('vip') || location.name.toLowerCase().includes('privado')"
                   [class.to-slate-800]="!location.name.toLowerCase().includes('jardin') && !location.name.toLowerCase().includes('terraza') && !location.name.toLowerCase().includes('central') && !location.name.toLowerCase().includes('principal') && !location.name.toLowerCase().includes('vip') && !location.name.toLowerCase().includes('privado')">
                
                <!-- Decorative background pattern -->
                <div class="absolute inset-0 opacity-5 pointer-events-none">
                  @if (location.name.toLowerCase().includes('jardin') || location.name.toLowerCase().includes('terraza')) {
                    <!-- Leaf pattern for garden/terrace -->
                    <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                      <pattern id="leaf-pattern-{{location.name}}" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                        <path d="M10 5 Q 15 10 10 15 Q 5 10 10 5 Z" fill="currentColor" class="text-emerald-400"/>
                      </pattern>
                      <rect width="100" height="100" fill="url(#leaf-pattern-{{location.name}})"/>
                    </svg>
                  } @else if (location.name.toLowerCase().includes('central') || location.name.toLowerCase().includes('principal')) {
                    <!-- Grid pattern for central area -->
                    <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                      <pattern id="grid-pattern-{{location.name}}" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
                        <rect width="10" height="10" fill="none" stroke="currentColor" stroke-width="0.5" class="text-amber-400"/>
                      </pattern>
                      <rect width="100" height="100" fill="url(#grid-pattern-{{location.name}})"/>
                    </svg>
                  } @else if (location.name.toLowerCase().includes('vip') || location.name.toLowerCase().includes('privado')) {
                    <!-- Diamond pattern for VIP -->
                    <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                      <pattern id="diamond-pattern-{{location.name}}" x="0" y="0" width="15" height="15" patternUnits="userSpaceOnUse">
                        <path d="M7.5 0 L15 7.5 L7.5 15 L0 7.5 Z" fill="none" stroke="currentColor" stroke-width="0.5" class="text-blue-400"/>
                      </pattern>
                      <rect width="100" height="100" fill="url(#diamond-pattern-{{location.name}})"/>
                    </svg>
                  }
                </div>

                <div class="flex items-center mb-2 relative z-10">
                  <span class="text-lg mr-1.5">{{ getLocationIcon(location.name) }}</span>
                  <h3 class="text-sm font-semibold text-slate-100">{{ location.name }}</h3>
                  <span class="ml-1.5 text-[10px] text-slate-400">({{ location.tables.length }})</span>
                </div>
                
                <div class="grid grid-cols-4 gap-2 relative z-10">
                  @for(table of location.tables; track table.id) {
                    <div 
                      class="relative group cursor-pointer transition-all duration-200 transform hover:scale-105"
                      [class.opacity-50]="!table.isAvailable || table.capacity < guests()"
                      [class.cursor-not-allowed]="!table.isAvailable || table.capacity < guests()"
                      (click)="selectTable(table)">
                      
                      <!-- Table Visual -->
                      <div 
                        class="flex flex-col items-center justify-center h-14 w-14 mx-auto text-slate-100 font-bold transition-all duration-200 relative"
                        [class.bg-emerald-600]="table.isAvailable && table.capacity >= guests()"
                        [class.bg-rose-700]="!table.isAvailable"
                        [class.bg-yellow-600]="table.isAvailable && table.capacity < guests()"
                        [class.ring-4]="isTableSelected(table)"
                        [class.ring-amber-500]="isTableSelected(table)"
                        [class.rounded-lg]="table.shape === 'square'"
                        [class.rounded-full]="table.shape === 'round'">
                        
                        <!-- Table Number -->
                        <div class="text-xs font-bold">{{ table.code || table.id }}</div>
                        <!-- Capacity -->
                        <div class="text-[9px] opacity-75">{{ table.capacity }}p</div>
                        
                        <!-- Selection indicator -->
                        @if(isTableSelected(table)) {
                          <div class="absolute -top-0.5 -right-0.5 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center">
                            <span class="text-slate-900 text-[9px] font-bold">‚úì</span>
                          </div>
                        }
                      </div>
                      
                      <!-- Table Status -->
                      <div class="text-center mt-0.5">
                        @if (!table.isAvailable) {
                          <span class="text-[9px] text-rose-400 font-medium">Ocupada</span>
                        } @else if (table.capacity < guests()) {
                          <span class="text-[9px] text-yellow-400 font-medium">Peque√±a</span>
                        } @else {
                          <span class="text-[9px] text-emerald-400 font-medium">Libre</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
          
          <div class="mt-6 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">
              ü†¨ Atr√°s
            </button>
            <button 
              (click)="nextStep()" 
              [disabled]="!selectedTable()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              Continuar ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 4: Menu -->
      @case (4) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-4 text-center">üçΩÔ∏è Pre-ordena tu Comida</h2>
          <p class="text-slate-300 text-center mb-6">Opcional - Selecciona tus platos favoritos y tenlos listos al llegar</p>
          
          <!-- Layout: Catalog on Left, Cart on Right -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- LEFT: Menu Catalog (2/3 width) -->
            <div class="lg:col-span-2">
              <!-- Search Bar -->
              <div class="mb-4">
                <div class="relative">
                  <input 
                    type="text" 
                    placeholder="Buscar platos..." 
                    (input)="onMenuSearch($event)"
                    [value]="menuSearchQuery()"
                    class="w-full px-4 py-2.5 pl-10 bg-slate-700 border border-slate-600 rounded-full text-white placeholder-slate-400 focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-500/20 transition-all text-sm">
                  <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
              </div>

              <!-- Loading State -->
              @if (menuLoading()) {
                <div class="text-center py-8">
                  <div class="inline-flex items-center px-4 py-2 bg-slate-700 rounded-lg">
                    <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-slate-300 text-sm">Cargando men√∫...</span>
                  </div>
                </div>
              }

              <!-- Error State -->
              @if (menuError() && !menuLoading()) {
                <div class="mb-4">
                  <div class="bg-amber-900/20 border border-amber-500/30 rounded-lg p-3 text-center">
                    <div class="flex items-center justify-center mb-2 text-sm">
                      <svg class="w-4 h-4 text-amber-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                      </svg>
                      <span class="text-amber-400 font-medium text-sm">{{ menuError() }}</span>
                    </div>
                    <button 
                      (click)="refreshMenuItems()" 
                      class="px-3 py-1.5 bg-amber-500 text-slate-900 rounded-lg hover:bg-amber-600 transition-colors text-xs font-medium">
                      Reintentar
                    </button>
                  </div>
                </div>
              }

              @if (!menuLoading()) {
                <!-- Categories Filter -->
                @if (menuCategories().length > 0) {
                  <div class="mb-4">
                    <div class="flex flex-wrap gap-2">
                      <button 
                        (click)="selectMenuCategory('all')"
                        [class]="selectedMenuCategory() === 'all' ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'"
                        class="px-3 py-1.5 rounded-full font-medium transition-colors text-xs">
                        üçΩÔ∏è Todo
                      </button>
                      @for (category of menuCategories(); track category.id) {
                        <button 
                          (click)="selectMenuCategory(category.id)"
                          [class]="selectedMenuCategory() === category.id ? 'bg-amber-500 text-slate-900' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'"
                          class="px-3 py-1.5 rounded-full font-medium transition-colors text-xs">
                          {{ category.icon }} {{ category.name }}
                        </button>
                      }
                    </div>
                  </div>
                }

                <!-- Compact Menu Items List -->
                <div class="max-h-[500px] overflow-y-auto pr-2 space-y-2">
                  @if (filteredMenuItems().length > 0) {
                    @for (item of filteredMenuItems(); track item.id) {
                      <div class="bg-slate-700 rounded-lg p-3 border border-slate-600 hover:border-amber-500/50 transition-all flex items-center gap-3">
                        <!-- Thumbnail Image -->
                        @if (item.image) {
                          <div class="w-16 h-16 flex-shrink-0 rounded-md bg-cover bg-center relative" [style.background-image]="'url(' + item.image + ')'">
                            <div class="absolute inset-0 bg-black/20 rounded-md"></div>
                            @if (item.popular) {
                              <span class="absolute -top-1 -right-1 bg-amber-500 text-slate-900 px-1.5 py-0.5 rounded-full text-[8px] font-bold">
                                ‚≠ê
                              </span>
                            }
                          </div>
                        } @else {
                          <div class="w-16 h-16 flex-shrink-0 rounded-md bg-slate-600 flex items-center justify-center">
                            <span class="text-2xl">üçΩÔ∏è</span>
                          </div>
                        }
                        
                        <!-- Item Info -->
                        <div class="flex-grow min-w-0">
                          <h4 class="text-sm font-semibold text-white truncate">{{ item.name }}</h4>
                          <p class="text-slate-400 text-xs line-clamp-1 mb-1">{{ item.description }}</p>
                          <div class="flex items-center gap-2">
                            <span class="text-amber-500 font-bold text-sm">S/{{ item.price }}</span>
                            @if (item.stock !== undefined && item.stock === 0) {
                              <span class="text-red-400 text-[10px]">‚ùå Agotado</span>
                            } @else if (item.popular) {
                              <span class="text-amber-400 text-[10px]">üî• Popular</span>
                            }
                          </div>
                        </div>
                        
                        <!-- Add/Remove Controls -->
                        <div class="flex-shrink-0">
                          @if (getItemQuantity(item.id) > 0) {
                            <div class="flex items-center gap-2 bg-slate-800 rounded-lg p-1">
                              <button (click)="removeMenuItemFromBooking(item.id)" class="w-7 h-7 rounded-md bg-slate-600 hover:bg-slate-500 text-white text-sm flex items-center justify-center font-bold">-</button>
                              <span class="text-sm font-bold text-white w-6 text-center">{{ getItemQuantity(item.id) }}</span>
                              <button (click)="addMenuItemToBooking(item)" class="w-7 h-7 rounded-md bg-amber-500 hover:bg-amber-400 text-slate-900 text-sm flex items-center justify-center font-bold">+</button>
                            </div>
                          } @else {
                            <button 
                              (click)="addMenuItemToBooking(item)"
                              [disabled]="item.stock === 0"
                              [class]="item.stock === 0 ? 'bg-slate-600 text-slate-400 cursor-not-allowed' : 'bg-amber-500 hover:bg-amber-600 text-white'"
                              class="px-4 py-2 rounded-lg font-medium text-xs transition-colors">
                              {{ item.stock === 0 ? 'Agotado' : '+ Agregar' }}
                            </button>
                          }
                        </div>
                      </div>
                    }
                  } @else {
                    <!-- No Results Found -->
                    <div class="text-center py-12">
                      <div class="text-4xl mb-3">üîç</div>
                      <h3 class="text-lg font-bold text-slate-300 mb-2">No se encontraron platos</h3>
                      <p class="text-slate-400 mb-4 text-sm">Intenta con otros t√©rminos de b√∫squeda o selecciona otra categor√≠a</p>
                      <button 
                        (click)="selectMenuCategory('all'); menuSearchQuery.set('')"
                        class="px-4 py-2 bg-amber-500 text-slate-900 rounded-full font-medium hover:bg-amber-600 transition-colors text-sm">
                        Ver todo el men√∫
                      </button>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- RIGHT: Shopping Cart (1/3 width) -->
            <div class="lg:col-span-1">
              <div class="bg-slate-700 rounded-lg border-2 border-slate-600 sticky top-4">
                <div class="p-4 border-b border-slate-600">
                  <h3 class="text-lg font-bold text-amber-500 flex items-center gap-2">
                    üõí Tu Pre-orden
                    @if (currentReservation().menuItems.length > 0) {
                      <span class="text-xs bg-amber-500 text-slate-900 rounded-full px-2 py-0.5 font-bold">
                        {{ currentReservation().menuItems.length }}
                      </span>
                    }
                  </h3>
                </div>
                
                @if (currentReservation().menuItems.length > 0) {
                  <!-- Cart Items List -->
                  <div class="p-4 space-y-3 max-h-[400px] overflow-y-auto">
                    @for (orderItem of currentReservation().menuItems; track orderItem.item.id) {
                      <div class="bg-slate-800 rounded-lg p-3 border border-slate-600">
                        <div class="flex justify-between items-start mb-2">
                          <h4 class="text-sm font-semibold text-white flex-grow pr-2">{{ orderItem.item.name }}</h4>
                          <button 
                            (click)="removeMenuItemFromBooking(orderItem.item.id)"
                            class="text-red-400 hover:text-red-300 flex-shrink-0"
                            title="Eliminar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                          </button>
                        </div>
                        
                        <div class="flex justify-between items-center">
                          <div class="flex items-center gap-2 bg-slate-700 rounded-lg p-1">
                            <button 
                              (click)="removeMenuItemFromBooking(orderItem.item.id)" 
                              class="w-6 h-6 rounded-md bg-slate-600 hover:bg-slate-500 text-white text-xs flex items-center justify-center font-bold">
                              -
                            </button>
                            <span class="text-xs font-bold text-white w-5 text-center">{{ orderItem.quantity }}</span>
                            <button 
                              (click)="addMenuItemToBooking(orderItem.item)" 
                              class="w-6 h-6 rounded-md bg-amber-500 hover:bg-amber-400 text-slate-900 text-xs flex items-center justify-center font-bold">
                              +
                            </button>
                          </div>
                          <div class="text-right">
                            <div class="text-xs text-slate-400">S/{{ orderItem.item.price }} c/u</div>
                            <div class="text-sm font-bold text-amber-500">S/{{ (orderItem.item.price * orderItem.quantity).toFixed(2) }}</div>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                  
                  <!-- Cart Total -->
                  <div class="p-4 border-t-2 border-slate-600 bg-gradient-to-br from-amber-500/10 to-amber-600/5">
                    <div class="flex justify-between items-center mb-2">
                      <span class="text-slate-300 font-semibold">Subtotal:</span>
                      <span class="text-white font-bold text-lg">{{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-amber-500 font-bold text-lg">Total:</span>
                      <span class="text-amber-500 font-bold text-lg">{{ menuTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
                    </div>
                  </div>
                } @else {
                  <!-- Empty Cart State -->
                  <div class="p-8 text-center">
                    <div class="text-5xl mb-3 opacity-50">üõí</div>
                    <p class="text-slate-400 text-sm mb-2">Tu carrito est√° vac√≠o</p>
                    <p class="text-slate-500 text-xs">Agrega platos del men√∫ para pre-ordenar</p>
                  </div>
                }
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-center gap-4">
            <button (click)="prevStep()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all">ü†¨ Atr√°s</button>
            <button (click)="nextStep()" class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all">
              Continuar al Resumen ü†Æ
            </button>
          </div>
        </div>
      }
      <!-- Step 5: Summary -->
      @case (5) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">5. Resumen de la Reserva</h2>
          <div class="bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Datos del Titular:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Nombre:</span> <span class="font-bold">{{ customerName() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Email:</span> <span class="font-bold">{{ customerEmail() }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Tel√©fono:</span> <span class="font-bold">{{ customerPhone() }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Detalles de la Reserva:</h4>
            <div class="flex justify-between"><span class="text-slate-400">Fecha y Hora:</span> <span class="font-bold">{{ currentReservation().date }} a las {{ currentReservation().time }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Comensales:</span> <span class="font-bold">{{ currentReservation().guests }}</span></div>
            <div class="flex justify-between"><span class="text-slate-400">Mesa:</span> <span class="font-bold">Mesa #{{ currentReservation().table?.id }}</span></div>
            <hr class="border-slate-600">
            <h4 class="text-lg font-semibold text-slate-100">Pedido del Men√∫:</h4>
            @if(currentReservation().menuItems.length > 0) {
              @for(orderItem of currentReservation().menuItems; track orderItem.item.id) {
                <div class="flex justify-between">
                  <span>{{ orderItem.item.name }} x {{ orderItem.quantity }}</span>
                  <span>{{ (orderItem.item.price * orderItem.quantity) | currency }}</span>
                </div>
              }
              <hr class="border-slate-600">
              <div class="space-y-2">
                <div class="flex justify-between text-slate-300">
                  <span>Subtotal:</span>
                  <span>{{ subtotalSinIGV() | currency:'PEN':'symbol':'1.2-2' }}</span>
                </div>
                <div class="flex justify-between text-slate-300">
                  <span>IGV (18%):</span>
                  <span>{{ igvAmount() | currency:'PEN':'symbol':'1.2-2' }}</span>
                </div>
                <hr class="border-slate-600">
                <div class="flex justify-between text-xl font-bold text-amber-500">
                  <span>Total:</span>
                  <span>{{ totalConIGV() | currency:'PEN':'symbol':'1.2-2' }}</span>
                </div>
              </div>
            } @else {
              <p class="text-slate-400">No se pre-orden√≥ comida.</p>
            }
          </div>

          <div class="mt-6 bg-slate-700 p-6 rounded-lg space-y-4">
            <h4 class="text-lg font-semibold text-slate-100">Peticiones Especiales (Opcional)</h4>
            <div>              
              <textarea id="specialRequests" [value]="currentReservation().specialRequests" (input)="updateSpecialRequests($event)" rows="3" class="w-full bg-slate-600 border-slate-500 text-slate-100 rounded-md p-3 focus:ring-amber-500 focus:border-amber-500" placeholder="Ej: Alergias, celebraci√≥n de cumplea√±os, etc."></textarea>
            </div>
          </div>

          @if(menuTotal() > 0) {
            <div class="mt-6">
              <label class="flex items-center">
                <input type="checkbox" [checked]="termsAccepted()" (change)="updateTerms($event)" class="h-4 w-4 rounded border-slate-500 bg-slate-600 text-amber-600 focus:ring-amber-500">
                <span class="ml-2 text-slate-300">Acepto los <button type="button" (click)="isTermsModalOpen.set(true)" class="text-amber-500 hover:underline inline font-medium">t√©rminos y condiciones</button> de la pre-orden.</span>
              </label>
            </div>
          }

          <div class="mt-8 flex justify-center gap-4">
            <button (click)="prevStep()" [disabled]="paymentProcessing()" class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">Atr√°s</button>
            <button (click)="completeBooking()"
                    [disabled]="(menuTotal() > 0 && !termsAccepted()) || !currentReservation().customerName || !currentReservation().customerEmail || paymentProcessing()"
                    class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed">
              @if(paymentProcessing()) {
                <span class="flex items-center gap-2">
                  <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Procesando...
                </span>
              } @else if(menuTotal() > 0) {
                <span>Confirmar y Pagar</span>
              } @else {
                <span>Confirmar Reserva</span>
              }
            </button>
          </div>
        </div>
      }
      <!-- Step 6: Payment Type Selection -->
      @case (6) {
        <div class="animate-fade-in">
          <h2 class="text-3xl font-bold text-slate-100 mb-6">üí≥ Forma de Pago</h2>
          <p class="text-slate-300 text-center mb-8">Elige c√≥mo prefieres realizar el pago de tu pre-orden</p>
          
          <!-- Payment Summary -->
          <div class="bg-slate-700 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-semibold text-amber-500 mb-4">Resumen del Monto a Pagar</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-slate-300">Subtotal:</span>
                <span class="font-semibold">{{ subtotalSinIGV() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-300">IGV (18%):</span>
                <span class="font-semibold">{{ igvAmount() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
              <hr class="border-slate-600 my-3">
              <div class="flex justify-between text-xl font-bold text-amber-500">
                <span>Total a Pagar:</span>
                <span>{{ totalConIGV() | currency:'PEN':'symbol':'1.2-2' }}</span>
              </div>
            </div>
          </div>

          <!-- Payment Type Options -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Online Payment Option -->
            <div class="bg-slate-700 rounded-lg p-6 border-2 transition-all cursor-pointer hover:border-amber-500"
                 [class.border-amber-500]="paymentType() === 'online'"
                 [class.bg-amber-500/10]="paymentType() === 'online'"
                 (click)="selectPaymentType('online')">
              <div class="text-center">
                <div class="text-4xl mb-4">üí≥</div>
                <h3 class="text-xl font-bold text-slate-100 mb-3">Pago Online</h3>
                <p class="text-slate-300 mb-4">Paga ahora de forma segura con tu tarjeta de cr√©dito o d√©bito</p>
                
                <!-- Payment Methods Logos -->
                <div class="flex items-center justify-center gap-3 mb-4">
                  <div class="bg-white px-3 py-2 rounded-lg shadow-md">
                    <img src="https://static.culqi.com/v2/v2/static/img/logo.png" alt="Culqi" class="h-5 w-auto">
                  </div>
                </div>
                
                <div class="bg-green-600 text-white py-2 px-4 rounded-full text-sm font-medium inline-block">
                  ‚úì Pago Inmediato
                </div>
              </div>
              <div class="mt-4 text-sm text-slate-400 space-y-1">
                <p>üîí Pago seguro con <strong class="text-green-400">CULQI</strong></p>
                <p>‚úì Tarjetas Visa, DinersMastercard, Amex</p>
                <p>‚úì Confirmaci√≥n autom√°tica instant√°nea</p>
              </div>
            </div>

            <!-- Presential Payment Option -->
            <div class="bg-slate-700 rounded-lg p-6 border-2 transition-all cursor-pointer hover:border-amber-500"
                 [class.border-amber-500]="paymentType() === 'presencial'"
                 [class.bg-amber-500/10]="paymentType() === 'presencial'"
                 (click)="selectPaymentType('presencial')">
              <div class="text-center">
                <div class="text-4xl mb-4">üè™</div>
                <h3 class="text-xl font-bold text-slate-100 mb-3">Pago Presencial</h3>
                <p class="text-slate-300 mb-4">Paga cuando llegues al restaurante</p>
                <div class="bg-orange-600 text-white py-2 px-4 rounded-full text-sm font-medium inline-block">
                  üìÖ Pagar en Local
                </div>
              </div>
              <div class="mt-4 text-sm text-slate-400">
                <p>‚Ä¢ Pago en efectivo o tarjeta</p>
                <p>‚Ä¢ Debes llegar <strong class="text-orange-400">dentro de 24 horas</strong></p>
                <p>‚Ä¢ Confirma tu llegada al personal</p>
              </div>
            </div>
          </div>

          <!-- Important Notice for Online Payment -->
          @if (paymentType() === 'online' && !paymentProcessing()) {
            <div class="bg-green-900 border border-green-500 rounded-lg p-6 mb-6">
              <h4 class="text-lg font-semibold text-green-200 mb-2">üí≥ Pago Online</h4>
              <div class="text-green-300 space-y-2">
                <p>‚Ä¢ Una vez realizado el pago, tu reserva quedar√° <strong>CONFIRMADA</strong>.</p>
                <p>‚Ä¢ Recibir√°s un comprobante de pago y los detalles de tu reserva por correo.</p>
              </div>
            </div>
          }

          <!-- Important Notice for Presential Payment -->
          @if (paymentType() === 'presencial' && !paymentProcessing()) {
            <div class="bg-orange-900 border border-orange-500 rounded-lg p-6 mb-6">
              <h4 class="text-lg font-semibold text-orange-200 mb-2">‚ö†Ô∏è Importante - Pago Presencial</h4>
              <div class="text-orange-300 space-y-2">
                <p>‚Ä¢ <strong>Debes acercarte al restaurante dentro de las pr√≥ximas 24 horas</strong> para confirmar y pagar tu reserva.</p>
                <p>‚Ä¢ La reserva quedar√° en estado <strong>PENDIENTE DE PAGO</strong> hasta tu llegada.</p>
                <p>‚Ä¢ Puedes pagar en efectivo o con tarjeta en el local.</p>
                <p>‚Ä¢ Si no confirmas el pago en 24 horas, tu reserva ser√° cancelada autom√°ticamente.</p>
              </div>
            </div>
          }

          <!-- Processing State for Presential Payment -->
          @if (paymentProcessing()) {
            <div class="bg-blue-900 p-6 rounded-lg text-center mb-6">
              <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
              <h3 class="text-xl font-semibold text-blue-200 mb-2">Procesando Reserva...</h3>
              <p class="text-blue-300">Por favor espere mientras confirmamos su reserva con pago presencial.</p>
            </div>
          }

          <!-- Error State -->
          @if (paymentError() && !paymentProcessing()) {
            <div class="bg-red-900 p-6 rounded-lg mb-6">
              <h3 class="text-xl font-semibold text-red-200 mb-2">‚ùå Error</h3>
              <p class="text-red-300">{{ paymentError() }}</p>
              <button 
                (click)="clearPaymentError()" 
                class="mt-4 bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors">
                Intentar Nuevamente
              </button>
            </div>
          }

          <div class="mt-8 flex justify-center gap-4">
            <button 
              (click)="prevStep()" 
              [disabled]="paymentProcessing()"
              class="bg-slate-600 text-slate-100 font-bold py-3 px-8 rounded-full hover:bg-slate-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
              ü†¨ Atr√°s
            </button>
            <button 
              (click)="confirmReservation()"
              [disabled]="!paymentType() || paymentProcessing()"
              class="bg-amber-500 text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-amber-400 transition-all disabled:bg-slate-600 disabled:cursor-not-allowed disabled:text-slate-400">
              @if(paymentType() === 'online') {
                Proceder al Pago üí≥
              } @else {
                Confirmar Reserva ‚ú®
              }
            </button>
          </div>
        </div>
      }
    }
  </div>
</div>

<!-- Global Processing Overlay -->
@if (paymentProcessing()) {
  <div class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-slate-800 p-10 rounded-2xl shadow-2xl text-center max-w-md border-2 border-blue-500">
      <div class="animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-6"></div>
      @if (paymentType() === 'online') {
        <h3 class="text-2xl font-bold text-blue-200 mb-3">Procesando Pago...</h3>
        <p class="text-blue-300 mb-2">Por favor espere mientras procesamos su pago de forma segura.</p>
        <p class="text-blue-400 text-sm">No cierre ni actualice esta p√°gina</p>
        <div class="mt-6 flex items-center justify-center space-x-2 text-green-400 text-sm">
          <span>üîí</span>
          <span>Conexi√≥n segura con Culqi</span>
        </div>
      } @else {
        <h3 class="text-2xl font-bold text-blue-200 mb-3">Procesando Reserva...</h3>
        <p class="text-blue-300 mb-2">Por favor espere mientras confirmamos su reserva.</p>
        <p class="text-blue-400 text-sm">No cierre ni actualice esta p√°gina</p>
        <div class="mt-6 flex items-center justify-center space-x-2 text-amber-400 text-sm">
          <span>üìÖ</span>
          <span>Generando c√≥digo de reserva</span>
        </div>
      }
    </div>
  </div>
}

<!-- Payment Error Modal -->
@if (paymentError() && !paymentProcessing()) {
  <div class="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-lg border border-amber-400/50 animate-fade-in">
      <!-- Icon with subtle background -->
      <div class="flex justify-center mb-6">
        <div class="bg-amber-500/10 p-4 rounded-full">
          <svg class="w-12 h-12 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>
      
      <!-- Content -->
      <div class="text-center mb-6">
        <h3 class="text-xl font-bold text-slate-100 mb-3">Pago No Procesado</h3>
        <p class="text-slate-300 text-sm leading-relaxed mb-4">{{ paymentError() }}</p>
        
        <!-- Important Notice -->
        <div class="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-lg text-left">
          <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-emerald-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="text-emerald-300 font-semibold mb-2">¬°Tu reserva S√ç fue creada exitosamente!</p>
              <p class="text-slate-300 text-xs leading-relaxed">Aunque el pago no pudo procesarse, tu mesa est√° reservada.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Payment Window Notice -->
      <div class="bg-slate-700/50 p-4 rounded-lg mb-6 text-left">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <div>
            <p class="text-amber-300 font-semibold text-sm mb-1">Tienes 24 horas para completar el pago</p>
            <p class="text-slate-400 text-xs leading-relaxed mb-2">Comun√≠cate con el restaurante para regularizar tu pago:</p>
            <ul class="text-slate-400 text-xs space-y-1 ml-4">
              <li>‚Ä¢ Por tel√©fono o WhatsApp</li>
              <li>‚Ä¢ Directamente en el local</li>
              <li>(*)No garantizamos la pre orden de comida sin pago confirmado</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="flex justify-center">
        <button 
          (click)="navigateToConfirmationWithPendingPayment()" 
          class="bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-8 py-3 rounded-lg transition-colors shadow-lg shadow-emerald-500/20">
          Ver Reserva
        </button>
      </div>
    </div>
  </div>
}

<app-modal [isOpen]="isTermsModalOpen()" title="T√©rminos y Condiciones de Pre-orden" (closeModal)="isTermsModalOpen.set(false)">
  <div class="space-y-4 text-slate-300 max-h-[60vh] overflow-y-auto pr-4 text-sm">
    <h4 class="font-bold text-slate-100 text-base">1. Pre-orden y Pago</h4>
    <p>Al pre-ordenar un men√∫, usted acepta pagar el monto total indicado en el resumen de la reserva. El pago se procesar√° a trav√©s de nuestra pasarela de pagos segura. Este pago garantiza la preparaci√≥n de sus platos y no es reembolsable.</p>
    
    <h4 class="font-bold text-slate-100 text-base">2. Pol√≠tica de Cancelaci√≥n</h4>
    <p>La reserva de la mesa puede ser cancelada hasta 24 horas antes de la hora programada sin penalizaci√≥n. Sin embargo, el costo de la comida pre-ordenada no es reembolsable, ya que los ingredientes se adquieren y preparan con antelaci√≥n.</p>
    
    <h4 class="font-bold text-slate-100 text-base">3. Puntualidad</h4>
    <p>Le solicitamos llegar a tiempo a su reserva. Mantendremos su mesa por un per√≠odo de gracia de 15 minutos. Pasado este tiempo, la mesa podr√≠a ser asignada a otros clientes y su pre-orden ser√° mantenida para cuando usted llegue, aunque no podemos garantizarle una mesa de inmediato.</p>

    <h4 class="font-bold text-slate-100 text-base">4. Cambios en la Reserva</h4>
    <p>Cualquier cambio en el n√∫mero de comensales o en la hora de la reserva debe ser notificado con al menos 6 horas de antelaci√≥n y est√° sujeto a disponibilidad. No se pueden realizar cambios en los platos pre-ordenados una vez confirmada la reserva.</p>
    
    <h4 class="font-bold text-slate-100 text-base">5. Alergias y Restricciones Diet√©ticas</h4>
    <p>Es responsabilidad del cliente informar sobre cualquier alergia o restricci√≥n diet√©tica en la secci√≥n de "Peticiones Especiales". Marakos Grill har√° todo lo posible por acomodar sus necesidades, pero no se hace responsable de reacciones adversas si no se ha notificado previamente.</p>
  </div>
</app-modal>

<!-- Modal de Confirmaci√≥n de Salida -->
<app-modal [isOpen]="isExitConfirmModalOpen()" title="¬øAbandonar Reserva?" (closeModal)="cancelExit()">
  <div class="space-y-6">
    <!-- Icono de Advertencia -->
    <div class="flex justify-center">
      <div class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
    </div>

    <!-- Mensaje -->
    <div class="text-center space-y-2">
      <p class="text-slate-200 text-base font-medium">
        Est√°s a punto de salir del proceso de reserva de mesa
      </p>
      <p class="text-slate-400 text-sm">
        Si sales ahora, perder√°s todos los datos ingresados y tendr√°s que empezar de nuevo.
      </p>
    </div>

    <!-- Botones -->
    <div class="flex gap-3 justify-center pt-2">
      <button
        type="button"
        (click)="cancelExit()"
        class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-medium transition-colors duration-200 min-w-[120px]"
      >
        Continuar Reserva
      </button>
      <button
        type="button"
        (click)="confirmExit()"
        class="px-6 py-2.5 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-medium transition-colors duration-200 min-w-[120px]"
      >
        Salir
      </button>
    </div>
  </div>
</app-modal>